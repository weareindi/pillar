"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}!function(){var e;e=function(){function e(t,r){var n=this;_classCallCheck(this,e),this.options=t,this.surface=r,this.intersecting=!1,this.current=0,this.registerDatasets().then((function(){return Promise.all([n.registerWorker(),n.registerIntersectionObserver(),n.registerWorkerListener(),n.registerMediaQueryListener()])})).catch((function(e){console.error(e)}))}return _createClass(e,[{key:"registerWorker",value:function(){var e=this;return new Promise((function(t,r){return e.worker=new Worker("".concat(e.options.path,"OffloadServiceWorker.js?v=").concat(e.options.version)),t()}))}},{key:"registerIntersectionObserver",value:function(){var e=this;return new Promise((function(t,r){return new IntersectionObserver((function(t,r){for(var n=0;n<t.length;n++)t[n].isIntersecting?(e.isIntersecting=!0,e.processImage()):e.isIntersecting=!1}),{threshold:0,rootMargin:"100px"}).observe(e.surface),t()}))}},{key:"processImage",value:function(){var e=this;this.getCurrentDataset().then((function(t){return e.hasBlob(t)?e.setStyle(t):e.getBlob(t)}))}},{key:"hasBlob",value:function(e){return void 0!==e.bloburl}},{key:"getBlob",value:function(e){var t=this;return new Promise((function(r,n){return t.worker.postMessage({event:"processUrl",dataset:e})}))}},{key:"isIntersecting",value:function(){var e=this;return new Promise((function(t,r){return t(e.intersecting)}))}},{key:"registerWorkerListener",value:function(){var e=this;return new Promise((function(t,r){return e.worker.addEventListener("message",(function(t){return void 0===t.data?r("No data returned"):void 0===t.data.event?r("No event returned"):"processedUrl"===t.data.event&&void 0!==t.data.dataset?e.updateDatasets(t.data.dataset).then((function(){return e.getCurrentDataset()})).then((function(t){return e.setStyle(t)})):void 0})),t()}))}},{key:"updateDatasets",value:function(e){var t=this;return new Promise((function(r,n){return t.datasets=t.datasets.map((function(t){return t.uid===e.uid?e:t})),r()}))}},{key:"registerMediaQueryListener",value:function(){var e=this;return this.getMediaQueries().then((function(t){return t.forEach((function(t,r){t.addEventListener("change",(function(t){if(e.isIntersecting)return e.processImage()}))})),Promise.resolve()}))}},{key:"registerDatasets",value:function(){var e=this;return this.getDatasets().then((function(t){return e.sortDatasets(t)})).then((function(t){return e.datasets=t}))}},{key:"getDatasets",value:function(){var e=this;return new Promise((function(t,r){var n=e.surface.getAttribute("offload"),i=JSON.parse(n);return i.map((function(e,t){return e.uid=t,e})),e.surface.removeAttribute("offload"),e.surface.setAttribute("processed",JSON.stringify(i)),t(i)}))}},{key:"sortDatasets",value:function(e){return new Promise((function(t,r){return e.sort((function(e,t){return void 0===e.minwidth||parseFloat(e.minwidth)<parseFloat(t.minwidth)?-1:1})),t(e)}))}},{key:"getMediaQueries",value:function(){var e=this;return new Promise((function(t,r){var n=[];return e.datasets.forEach((function(e,t){var r=void 0!==e.minwidth?e.minwidth:"0em",i=window.matchMedia("(min-width: ".concat(r,")"));n.push(i)})),t(n)}))}},{key:"getCurrentDataset",value:function(){var e=this;return this.getCurrentMediaQuery().then((function(t){return e.datasets.find((function(e){return(void 0!==e.minwidth?parseInt(e.minwidth.replace(/\D/g,"")):0)===parseInt(t.media.replace(/\D/g,""))}))}))}},{key:"getCurrentMediaQuery",value:function(){return this.getMediaQueries().then((function(e){for(var t=e.length-1;t>=0;t--){var r=e[t];if(r.matches)return r}}))}},{key:"setStyle",value:function(e){var t=this;return new Promise((function(r,n){return t.surface.style.paddingTop="".concat(e.ratio,"%"),t.surface.style.backgroundImage="url('".concat(e.bloburl,"')"),r()}))}}]),e}(),new(function(){function t(e){var r=this;_classCallCheck(this,t),this.supportsWorkers()&&(this.options=Object.assign({path:"",version:"1.0.3"},e),this.processContainer(document.body).then((function(){return r.registerBinds()})).catch((function(e){console.error(e)})))}return _createClass(t,[{key:"supportsWorkers",value:function(){return"Worker"in window}},{key:"processContainer",value:function(e){var t=this;return this.getSurfaces(e).then((function(e){return t.processSurfaces(e)}))}},{key:"getSurfaces",value:function(e){return new Promise((function(t,r){var n=e.querySelectorAll("[offload]");if(n.length)return t(n)}))}},{key:"processSurfaces",value:function(t){var r=this,n=[];return t.forEach((function(t,i){var s=new Promise((function(n,i){return n(new e(r.options,t))}));n.push(s)})),Promise.all(n)}},{key:"registerBinds",value:function(){var e=this;new MutationObserver((function(t,r){t.forEach((function(t,r){e.processContainer(t.target).catch((function(e){console.error(e)}))}))})).observe(document.body,{attributes:!1,childList:!0,subtree:!0})}}]),t}())({path:"".concat(window.themeDir,"/_assets/js/")})}();